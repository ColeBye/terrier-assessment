<!DOCTYPE html>
<html lang="en">
  <script>
    function popModal(context, total_minutes) {
        document.getElementById("myModal").style.display = "block";
        document.getElementById("modal-context").innerText = context;

        let free_time = ""
        let hours = Math.floor(total_minutes / 60);
        let minutes = total_minutes % 60
        if (hours > 1) {
            free_time += hours + " hours ";
        }
        else if (hours === 1) {
            free_time += "1 hour ";
        }
        if (minutes > 1) {
            free_time += minutes + " minutes";
        }
        if (minutes === 1) {
            free_time += "1 minute";
        }

        document.getElementById("modal-minutes").innerText = free_time;
    }
    function closeModal() {
        document.getElementById("myModal").style.display = "none";
    }

  </script>


  <% content_for :title do %>
    Terrier Scheduler
  <% end %>

  <div class="empty-page" style="display: <%= (@work_orders.count == 0)? "flex" : "none" %>">
    <div class="empty-card card">
      <div class="card card-header">Database Empty!</div>
      <div class="card card-body">Use the rake page to fill out the schedule</div>
    </div>
  </div>

  <div class="modal" id="myModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-context">Modal Title</h5>
          <button type="button" class="btn-close" onclick="closeModal()" ></button>
        </div>
        <div class="modal-body" id="modal-minutes">
          <p>Modal Body</p>
        </div>
      </div>
    </div>
  </div>

  <div class="axis-holder border rounded" style="display: <%= (@work_orders.count == 0)? "none" : "grid" %>">

    <div class="corner-square card rounded-0 bg-light">
      <label>
        <% if @work_orders.count > 0 %>
          <%= @work_orders.first.date_time.month %> / <%= @work_orders.first.date_time.day %>
        <% end %>

      </label>
    </div>

    <div class="x-axis card-group">
        <% @technicians.each do |technician| %>
                <div class="technician-name card rounded-0 p-0 bg-light"><%= technician.name %></div>
        <% end %>
    </div>

    <div class="y-axis">
      <div class="time-labels">
        <% (@end_hour - @start_hour).times do |hour|%>
          <% if hour + @start_hour == 0 %>
            <div class="time-slot card rounded-0 bg-light">12:00 AM</div>
          <% elsif hour + @start_hour == 12 %>
            <div class="time-slot card rounded-0 bg-light">12:00 PM</div>
          <% elsif hour + @start_hour < 12 %>
            <div class="time-slot card rounded-0 bg-light"><%= (hour + @start_hour) %>:00 AM</div>
          <% else %>
            <div class="time-slot card rounded-0 bg-light"><%= (hour + @start_hour) % 12 %>:00 PM</div>
          <% end %>
        <% end %>
      </div>
    </div>
    <div class="new-grid">
      <% @technicians.each do |tech| %>
      <div class="new-column border border-left border-right">
        <% tech_orders = WorkOrder.where(technician: tech.technician_id).sort_by { |w| w.date_time + (w.duration * 60) } %>
        <% tech_orders.each_with_index do |wo, i| %>
          <!-- Start open block -->
          <% if wo == tech_orders.first && wo.date_time.seconds_since_midnight >  @start_hour * 3600 %>
            <% free_duration = wo.date_time.seconds_since_midnight - (@start_hour * 3600)%>
            <div class="open-time card" style="height: <%= free_duration * 8 / 3600 %>rem" onclick="popModal('Time to start:\n', parseInt(this.children[0].innerText))">
              <label><%= (free_duration / 60).to_i %></label>
            </div>
          <% end %>

          <!-- Not last case -->
          <% if wo != tech_orders.last %>
            <% free_duration = tech_orders[i + 1].date_time.seconds_since_midnight - (wo.date_time.seconds_since_midnight + (wo.duration * 60))%>
            <% if free_duration < 0 %>
              <!-- Overwritten by conflict case -->
              <div class="new-wo card bg-danger " style="height: <%= ((wo.duration / 60.0 ) + (free_duration / 3600)) * 8 %>rem">
                <% order_location = Location.where(location_id: wo.location).first %>
                <label >Conflict Detected!</label>
                <label class="card-time"><%= wo.date_time.strftime("%r") %></label>
                <label class="card-name"><%= order_location.name %></label>
                <label class="card-city text-truncate"><%= order_location.city %></label>
                <label class="card-price">$<%= wo.price %></label>
              </div>
            <% else %>
              <!-- Normal Event block -->
              <div class="new-wo card" style="height: <%= wo.duration * 8 / 60%>rem">
                <% order_location = Location.where(location_id: wo.location).first %>
                <label class="card-time bold"><%= wo.date_time.strftime("%r") %></label>
                <label class="card-name text-muted"><%= order_location.name %></label>
                <label class="card-city"><%= order_location.city %></label>
                <label class="card-price">$<%= wo.price %></label>
              </div>
              <% if free_duration > 0%>
                <div class="open-time card" style="height: <%= free_duration * 8 / 3600 %>rem" onclick="popModal('Time between events:\n', parseInt(this.children[0].innerText))">
                  <label><%= (free_duration / 60).to_i %></label>
                </div>
              <% end %>
            <% end %>
          <!-- Last case -->
          <% else %>
            <!-- Normal Event block -->
            <div class="new-wo card" style="height: <%= wo.duration * 8 / 60%>rem">
              <% order_location = Location.where(location_id: wo.location).first %>
              <label class="card-time"><%= wo.date_time.strftime("%r") %></label>
              <label class="card-name"><%= order_location.name %></label>
              <label class="card-city"><%= order_location.city %></label>
              <label class="card-price">$<%= wo.price %></label>
            </div>
            <!-- End open block -->
            <% if wo.date_time.seconds_since_midnight + (wo.duration * 60) < @end_hour * 3600%>
              <% free_duration = @end_hour * 3600 - (wo.date_time.seconds_since_midnight + (wo.duration * 60))%>
              <div class="open-time card" style="height: <%= free_duration * 8 / 3600 %>rem" onclick="popModal('Time to end:\n', parseInt(this.children[0].innerText))">
                <label><%= (free_duration / 60).to_i %></label>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
      <% end %>
    </div>
  </div>

</html>
